## 决策：升级系统的文件合并策略

- 标签：upgrade, file-merge, user-content
- 日期：2026-03-01

**摘要**：CLAUDE.md 使用智能合并保留用户内容，配置文件采用保守策略仅确保存在，避免复杂合并逻辑导致的错误。

### 背景

DevMind v0.5.0 引入升级系统时，需要决定如何处理用户已修改的文件。不同类型的文件有不同的合并需求。

### 方案对比

| 文件类型 | 方案 | 理由 |
|---------|------|------|
| CLAUDE.md | 智能合并 | 结构稳定，用户内容通常在末尾，可通过分隔符识别 |
| Slash 命令 | 完全覆盖 | 框架控制，用户不应修改 |
| 模式文档 | 完全覆盖 | 框架控制，用户不应修改 |
| config.yaml | 保守策略 | 结构可能变化，字段增删复杂，智能合并易出错 |
| flow.yaml | 保守策略 | 同上 |

### 决策

**CLAUDE.md 智能合并**：
- 在模板末尾添加分隔符：`---\n<!-- 以下为用户自定义内容，DevMind 升级时不会被覆盖 -->`
- 升级时提取分隔符后的内容，合并到新版本框架内容后
- 备份原文件为 `.claude/CLAUDE.md.backup`

**配置文件保守策略**：
- 仅确保文件存在，不做深度合并
- 未来版本可考虑使用 YAML 解析器实现字段级合并

### 影响

- 用户可以安全地在 CLAUDE.md 末尾添加自定义提示词
- 配置文件的新增字段需要用户手动添加（可接受的权衡）
- 降低了升级系统的复杂度和出错风险

### 相关文件

- `packages/cli/src/commands/upgrade.ts:78-115` (upgradeCLAUDEMD 函数)
- `packages/cli/src/templates.ts` (CLAUDE_MD 模板)
